{% load static %}
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'assets/css/profile.css' %}">
    <script src="{% static 'assets/js/profile.js' %}"></script>
    <title>{{ organization.name }} - معلومات المنظمة</title>
</head>
<body>
    <!-- Cover Image Carousel -->
    <div class="carousel-container">
        <div class="carousel-track">
            {% for image in gallery %}
                <div class="carousel-item">
                    <img src="{{ image.image.url }}" alt="Cover Image">
                </div>
            {% empty %}
                <div class="carousel-item">
                    <img src="{{ organization.logo.url }}" alt="Cover Image">
                </div>
            {% endfor %}
        </div>
        <div class="share-btn-container">
            <button class="share-btn" data-share-url="{{ request.build_absolute_uri }}" data-share-title="{{ organization.name }}" data-share-text="تعرف على {{ organization.name }} - {{ organization.description|truncatechars:50 }}"><i class="fas fa-share-alt"></i></button>
        </div>
        <div class="carousel-controls">
            <button class="carousel-prev"><i class="fas fa-chevron-right"></i></button>
            <div class="carousel-indicators"></div>
            <button class="carousel-next"><i class="fas fa-chevron-left"></i></button>
        </div>
    </div>

    <!-- Reels Slider -->
    {% if reels %}
    <div class="reels-slider-container">
        <div class="reels-slider-track">
            {% for reel in reels %}
            <div class="reel">
                <div class="reel-item">
                    <a href="{{ reel.video.url }}" target="_blank">
                        <div class="reel-thumbnail">
                            {% if reel.video_thumbnail %}
                                <img src="{{ reel.video_thumbnail.url }}" alt="reel">
                            {% endif %}
                        </div>
                    </a>
                </div>
                <span>
                    {{ reel.title }}
                </span>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Main Content -->
    <div class="main-content">
        <!-- Organization Details -->
        <div class="organization-details slide-in-left">
            <div class="details-header">
                <div class="organization-header">
                    <img src="{{ organization.logo.url }}" alt="{{ organization.name }}" class="organization-logo">
                    <div>
                        <h1 class="details-title">{{ organization.name }}</h1>
                    </div>
                </div>
            </div>

            <!-- New description section -->
            {% if organization.description %}
            <div class="organization-description-section">
                <h3 class="description-title">نبذة تعريفية</h3>
                <p class="description-text">{{ organization.description }}</p>
            </div>
            {% endif %}


            {% if offers %}
            <!-- Other Offers Section -->
            <section class="other-offers-section">
                <style>
                    .other-offers-track {
                        scroll-snap-type: x mandatory;
                        overflow-x: auto;
                        touch-action: pan-x;
                    }
                    .other-offer-card {
                        scroll-snap-align: start;
                        flex-shrink: 0;
                        width: 90%;
                        margin-right: 10px;
                    }
                </style>
                {% if offers %}
                    <div class="other-offers-container">
                        <div class="other-offers-slider">
                            <div class="other-offers-track" id="offersTrack">
                                {% for other_offer in offers %}
                                    {% if other_offer.id != offer.id %}
                                    <div class="other-offer-card fade-in">
                                        <div class="other-offer-content">
                                            <div class="other-offer-meta">
                                                <div class="offer-date">
                                                    <i class="fas fa-calendar-alt"></i>
                                                    <span>{{ other_offer.createdAt|date:"d/m/Y" }}</span>
                                                </div>
                                                <div class="offer-expires">
                                                    <i class="fas fa-clock"></i>
                                                    <span>ينتهي: {{ other_offer.expiresAt|date:"d/m/Y" }}</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="other-offer-image">
                                            <img src="{{ other_offer.cover.url }}" alt="{{ other_offer.content|truncatechars:50 }}" class="offer-cover">
                                            <div class="offer-overlay">
                                                <a href="/client_offers/{{ other_offer.short_url }}" class="view-offer-btn">
                                                    <i class="fas fa-eye"></i>
                                                    عرض التفاصيل
                                                </a>
                                            </div>
                                        </div>

                                    </div>
                                    {% endif %}
                                {% empty %}

                                {% endfor %}
                            </div>
                            
                            {% if offers|length > 1 %}
                            <div class="slider-indicators" id="indicators"></div>
                            {% endif %}
                        </div>
                    </div>
                {% endif %}
            </section>
            {% endif %}

            <!-- QR Modal -->
            <div id="qrModal" class="qr-modal">
                <div class="qr-modal-content">
                    <span class="qr-close" onclick="closeQR()">&times;</span>
                    <canvas id="qrCanvas"></canvas>
                </div>
            </div>

            <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
            <script>
                function generateQR(event, url) {
                    event.preventDefault();
                    const modal = document.getElementById('qrModal');
                    const canvas = document.getElementById('qrCanvas');
                    
                    // Clear previous QR code
                    canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
                    
                    // Generate new QR code
                    QRCode.toCanvas(canvas, url, { width: 200 }, function (error) {
                        if (error) console.error(error);
                    });
                    
                    modal.style.display = 'block';
                }

                function closeQR() {
                    document.getElementById('qrModal').style.display = 'none';
                }

                // Close modal when clicking outside
                window.onclick = function(event) {
                    const modal = document.getElementById('qrModal');
                    if (event.target == modal) {
                        modal.style.display = 'none';
                    }
                }
            </script>
        </div>
    </div>


    
    <!-- Fixed Bottom Navbar -->
    <div class="bottom-nav-squares">
        <div class="dropdown-square">
            <div class="square-header">
                <i class="fas fa-share-alt"></i>
                <span>وسائل التواصل</span>
            </div>
            {% if social_urls %}
                <div class="square-dropdown">
                    {% for social_url in social_urls %}
                        <div class="dropdown-item">
                            <div class="item-info">
                                <a href="{{ social_url.short_url }}" target="_blank">
                                    {% if social_url.social_media.icon_thumbnail %}
                                        <img src="{{ social_url.social_media.icon_thumbnail.url }}" alt="{{ social_url.social_media.name }}" class="dropdown-icon">
                                    {% endif %}
                                    <span class="dropdown-name">{{ social_url.social_media.name }}</span>
                                </a>
                            </div>
                            <div class="item-actions">
                                <button class="copy-btn" data-url="{{ social_url.short_url }}"><i class="fa fa-copy"></i></button>
                                <a href="#" class="qr-btn" onclick="generateQR(event, '{{ social_url.short_url }}')"><i class="fa fa-qrcode"></i></a>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        </div>
        
        <div class="dropdown-square">
            <div class="square-header">
                <i class="fas fa-truck"></i>
                <span>برامج التوصيل</span>
            </div>
            {% if delivery_companies %}
                <div class="square-dropdown">
                    {% for delivery in delivery_companies %}
                        <div class="dropdown-item">
                            <div class="item-info">
                                <a href="{{ delivery.short_url }}" target="_blank">
                                    {% if delivery.delivery_company.icon_thumbnail %}
                                        <img src="{{ delivery.delivery_company.icon_thumbnail.url }}" alt="{{ delivery.delivery_company.name }}" class="dropdown-icon">
                                    {% endif %}
                                    <span class="dropdown-name">{{ delivery.delivery_company.name }}</span>
                                </a>
                            </div>
                            <div class="item-actions">
                                <button class="copy-btn" data-url="{{ delivery.short_url }}"><i class="fa fa-copy"></i></button>
                                <a href="#" class="qr-btn" onclick="generateQR(event, '{{ delivery.short_url }}')"><i class="fa fa-qrcode"></i></a>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        </div>

        <div class="dropdown-square">
            <div class="square-header">
                <i class="fas fa-file-pdf dropdown-icon"></i>
                <span>الكتالوجات</span>
            </div>
            {% if catalogs %}
                <div class="square-dropdown">
                    {% for catalog in catalogs %}
                    <div class="dropdown-item">
                        <div class="item-info">
                            <a href="{{ catalog.short_url }}" target="_blank">
                                <span class="dropdown-name">
                                {% if catalog.catalog_type == 'OFFERS' %}
                                    العروض
                                {% elif catalog.catalog_type == 'MENU' %}
                                    المينيو
                                {% else %}
                                    الخصومات
                                {% endif %}
                                </span>
                            </a>
                        </div>
                        <div class="item-actions">
                            <button class="copy-btn" data-url="{{ catalog.short_url }}"><i class="fa fa-copy"></i></button>
                            <a href="#" class="qr-btn" onclick="generateQR(event, '{{ catalog.short_url }}')"><i class="fa fa-qrcode"></i></a>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% endif %}
        </div>

        <div class="dropdown-square">
            <div class="square-header">
                <i class="fas fa-map"></i>
                <span>الفروع</span>
            </div>
            {% if branches %}
                <div class="square-dropdown-left">
                    {% for branch in branches %}
                        <div class="dropdown-item">
                            <div class="item-info">
                            <a href="{{branch.short_url}}" target="_blank">
                                <span class="dropdown-name">{{ branch.name }}</span>
                            </a>
                            </div>
                            <div class="item-actions">
                                <button class="copy-btn" data-url="{{ branch.short_url }}"><i class="fa fa-copy"></i></button>
                                <a href="#" class="qr-btn" onclick="generateQR(event, '{{ branch.short_url }}')"><i class="fa fa-qrcode"></i></a>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        </div>

        <div class="dropdown-square">
            <div class="square-header">
                <i class="fas fa-link"></i>
                <span>الموقع الالكتروني</span>
            </div>
            <div class="square-dropdown-left">
                <div class="dropdown-item">
                    <div class="item-info">
                        <a href="{{ website_url }}" target="_blank">
                            <span class="dropdown-name"> الموقع الالكتروني </span>
                        </a>
                    </div>
                    <div class="item-actions">
                        <button class="copy-btn" data-url="{{ website_url }}"><i class="fa fa-copy"></i></button>
                        <a href="#" class="qr-btn" onclick="generateQR(event, '{{ website_url }}')"><i class="fa fa-qrcode"></i></a>
                    </div>
                </div>
                <div class="dropdown-item">
                    <div class="item-info">
                        <a href="{{ card_url }}" target="_blank">
                            <span class="dropdown-name show-on-mobile">
                                البطاقة التعريفية
                            </span>
                        </a> 
                    </div>
                    <div class="item-actions">
                        <button class="copy-btn" data-url="{{ card_url }}"><i class="fa fa-copy"></i></button>
                        <a href="#" class="qr-btn" onclick="generateQR(event, '{{ card_url }}')"><i class="fa fa-qrcode"></i></a>
                    </div>
                </div>
            </div>
        </div>
    </div>






    <!-- Fixed Bottom Navbar -->
    <div class="bottom-nav">
        <a href="mailto:{{ shareek.user.email }}" class="bottom-nav-item">
            <img src="{% static 'assets/icons/email.png' %}" alt="">
        </a>
        <a href="sms:{{ shareek.user.phonenumber }}" class="bottom-nav-item">
            <img src="{% static 'assets/icons/sms.png' %}" alt="">
        </a>
        <a href="tel:{{ shareek.user.phonenumber }}" class="bottom-nav-item">
            <img src="{% static 'assets/icons/phone.png' %}" alt="">
        </a>
        <a href="https://t.me/{{ shareek.user.phonenumber }}" class="bottom-nav-item">
            <img src="{% static 'assets/icons/telegram.png' %}" alt="">
        </a>
        <a href="https://wa.me/{{ shareek.user.phonenumber }}" class="bottom-nav-item">
            <img src="{% static 'assets/icons/whatsapp.png' %}" alt="">
        </a> 
    </div>
    <script>
        // Handle potential missing Telegram/WhatsApp variables
        document.addEventListener('DOMContentLoaded', function() {
            const telegramLink = document.querySelectorAll('[href^="https://t.me/"]');
            const whatsappLink = document.querySelectorAll('[href^="https://wa.me/"]');
            
            telegramLink.forEach(link => {
                if (link.href === 'https://t.me/') {
                    link.closest('.bottom-nav-item').style.display = 'none';
                }
            });
            
            whatsappLink.forEach(link => {
                if (link.href === 'https://wa.me/') {
                    link.closest('.bottom-nav-item').style.display = 'none';
                }
            });
        });
    </script>
</body>
</html>